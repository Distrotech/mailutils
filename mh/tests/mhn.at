# This file is part of GNU Mailutils. -*- Autotest -*-
# Copyright (C) 2010 Free Software Foundation, Inc.
#
# GNU Mailutils is free software; you can redistribute it and/or
# modify it under the terms of the GNU General Public License as
# published by the Free Software Foundation; either version 3, or (at
# your option) any later version.
#
# GNU Mailutils is distributed in the hope that it will be useful, but
# WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
# General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with GNU Mailutils.  If not, see <http://www.gnu.org/licenses/>.

m4_pushdef([MH_KEYWORDS],[mhn])

dnl -------------------------------------------------------------------
dnl 1. List mode
dnl -------------------------------------------------------------------

MH_CHECK([mhn -list],[mhn00 mhn-list],[
MUT_MBCOPY($abs_top_srcdir/testsuite/mh/mbox1,[Mail/inbox])
mhn +inbox -list all
],
[0],
[ msg part type/subtype              size  description
   1      text/plain                 937
   2      text/plain                 215
   3      multipart/mixed             2K
     1    text/plain                 230 How doth
     2    application/octet-stream   462 Father William Part I
   4      multipart/mixed             3K
     1    text/plain                 341 Father William Part I
     2    multipart/mixed             3K
     2.1  application/octet-stream   479 Father William Part II
     2.2  multipart/mixed             2K
     2.2.1 application/octet-stream   483 Father William Part III
     2.2.2 application/octet-stream   495 Father William Part IV
   5      multipart/mixed            355
     1    text/plain                   0 Empty part
     2    text/plain                   1 Single line part
])

MH_CHECK([mhn -list -realsize],[mhn01 mhn-list-realsize],[
MUT_MBCOPY($abs_top_srcdir/testsuite/mh/mbox1,[Mail/inbox])
mhn +inbox -list -realsize all
],
[0],
[ msg part type/subtype              size  description
   1      text/plain                 937
   2      text/plain                 215
   3      multipart/mixed             2K
     1    text/plain                 230 How doth
     2    application/octet-stream   341 Father William Part I
   4      multipart/mixed             3K
     1    text/plain                 341 Father William Part I
     2    multipart/mixed             3K
     2.1  application/octet-stream   352 Father William Part II
     2.2  multipart/mixed             2K
     2.2.1 application/octet-stream   357 Father William Part III
     2.2.2 application/octet-stream   366 Father William Part IV
   5      multipart/mixed            355
     1    text/plain                   0 Empty part
     2    text/plain                   1 Single line part
])

dnl -------------------------------------------------------------------
dnl 2. Store mode
dnl -------------------------------------------------------------------

MH_CHECK([mhn -store],[mhn02 mhn-store],[
MUT_MBCOPY($abs_top_srcdir/testsuite/mh/mbox1,[Mail/inbox])
mhn +inbox -store 4 || exit $?
for file in 4.1.plain 4.2.1.octet-stream 4.2.2.1.octet-stream 4.2.2.2.octet-stream
do
  echo == $file ==
  cat $file
done
],
[0],
[storing message 4 part 1 as file 4.1.plain
storing message 4 part 2.1 as file 4.2.1.octet-stream
storing message 4 part 2.2.1 as file 4.2.2.1.octet-stream
storing message 4 part 2.2.2 as file 4.2.2.2.octet-stream
== 4.1.plain ==
`You are old, Father William,' the young man said,
`And your hair has become very white;
And yet you incessantly stand on your head--
Do you think, at your age, it is right?'

`In my youth,' Father William replied to his son,
`I feared it might injure the brain;
But, now that I'm perfectly sure I have none,
Why, I do it again and again.'

== 4.2.1.octet-stream ==
`You are old,' said the youth, `as I mentioned before,
And have grown most uncommonly fat;
Yet you turned a back-somersault in at the door--
Pray, what is the reason of that?'

`In my youth,' said the sage, as he shook his grey locks,
`I kept all my limbs very supple
By the use of this ointment--one shilling the box--
Allow me to sell you a couple?'
== 4.2.2.1.octet-stream ==
`You are old,' said the youth, `and your jaws are too weak
For anything tougher than suet;
Yet you finished the goose, with the bones and the beak--
Pray how did you manage to do it?'

`In my youth,' said his father, `I took to the law,
And argued each case with my wife;
And the muscular strength, which it gave to my jaw,
Has lasted the rest of my life.'
== 4.2.2.2.octet-stream ==
`You are old,' said the youth, `one would hardly suppose
That your eye was as steady as ever;
Yet you balanced an eel on the end of your nose--
What made you so awfully clever?'

`I have answered three questions, and that is enough,'
Said his father; `don't give yourself airs!
Do you think I can listen all day to such stuff?
Be off, or I'll kick you down stairs!'
])

MH_CHECK([mhn -store -auto],[mhn03 mhn-store-auto],[
MUT_MBCOPY($abs_top_srcdir/testsuite/mh/mbox1,[Mail/inbox])
mhn +inbox -store -auto 4 | remove_curdir || exit $?
],
[0],
[storing message 4 part 1 as file msg.21
storing message 4 part 2.1 as file msg.22
storing message 4 part 2.2.1 as file msg.23
storing message 4 part 2.2.2 as file msg.24
])

MH_CHECK([mhn -store -auto -part],[mhn04 mhn-store-auto-part],[
MUT_MBCOPY($abs_top_srcdir/testsuite/mh/mbox1,[Mail/inbox])
mhn +inbox -store -auto -part 2.2.1 4 | remove_curdir || exit $?
],
[0],
[storing message 4 part 2.2.1 as file msg.23
])

MH_CHECK([mhn -store -auto (pathname safety)],[mhn05 mhn-store-auto-safety],[
mkdir Mail/inbox
sed 's|; *name="msg|; name="../msg|' \
  $abs_top_srcdir/testsuite/mh/mbox1/4 > Mail/inbox/4
mhn +inbox -store -auto -part 2.1 4 || echo $?
echo == 4.2.1.octet-stream ==
cat 4.2.1.octet-stream
],
[0],
[storing message 4 part 2.1 as file 4.2.1.octet-stream
== 4.2.1.octet-stream ==
`You are old,' said the youth, `as I mentioned before,
And have grown most uncommonly fat;
Yet you turned a back-somersault in at the door--
Pray, what is the reason of that?'

`In my youth,' said the sage, as he shook his grey locks,
`I kept all my limbs very supple
By the use of this ointment--one shilling the box--
Allow me to sell you a couple?'
])

MH_CHECK([mhn-storage],[mhn06 mhn-store-auto],[
mkdir Mail/inbox
cp $abs_top_srcdir/testsuite/mh/mbox1/4 Mail/inbox

mkdir out
echo "mhn-storage: $curdir/out" >> $MH

mhn +inbox -store 4 | remove_curdir || echo $?
],
[0],
[storing message 4 part 1 as file out/4.1.plain
storing message 4 part 2.1 as file out/4.2.1.octet-stream
storing message 4 part 2.2.1 as file out/4.2.2.1.octet-stream
storing message 4 part 2.2.2 as file out/4.2.2.2.octet-stream
])

MH_CHECK([mhn-store-: all escapes],[mhn07 mhn-store_escapes],[
mkdir Mail/inbox
cp $abs_top_srcdir/testsuite/mh/mbox1/4 Mail/inbox
echo "mhn-store-application: %%-%m%P.%s-%p" >> $MH
mhn +inbox -store 4 | remove_curdir || exit $?
find . -name '%*'
],
[0],
[storing message 4 part 1 as file 4.1.plain
storing message 4 part 2.1 as file %4.2.1.octet-stream-2.1
storing message 4 part 2.2.1 as file %4.2.2.1.octet-stream-2.2.1
storing message 4 part 2.2.2 as file %4.2.2.2.octet-stream-2.2.2
./%4.2.1.octet-stream-2.1
./%4.2.2.1.octet-stream-2.2.1
./%4.2.2.2.octet-stream-2.2.2
])

MH_CHECK([mhn-store-: absolute path],[mhn08 mhn-store_abspath],[
mkdir Mail/inbox
mkdir out
cp $abs_top_srcdir/testsuite/mh/mbox1/4 Mail/inbox
echo "mhn-store-application: $curdir/out/%m%P.%s" >> $MH
mhn +inbox -store 4 | remove_curdir || exit $?
],
[0],
[storing message 4 part 1 as file 4.1.plain
storing message 4 part 2.1 as file out/4.2.1.octet-stream
storing message 4 part 2.2.1 as file out/4.2.2.1.octet-stream
storing message 4 part 2.2.2 as file out/4.2.2.2.octet-stream
])

MH_CHECK([mhn-store-: +folder],[mhn09 mhn-store+folder],[
mkdir Mail/inbox
mkdir Mail/app
cp $abs_top_srcdir/testsuite/mh/mbox1/4 Mail/inbox
echo "mhn-store-application: +app" >> $MH
mhn +inbox -store 4 | remove_curdir || exit $?
],
[0],
[storing message 4 part 1 as file 4.1.plain
storing message 4 part 2.1 to folder +app as message 1
storing message 4 part 2.2.1 to folder +app as message 2
storing message 4 part 2.2.2 to folder +app as message 3
])

MH_CHECK([mhn-store-: +],[mhn10 mhn-store+],[
mkdir Mail/inbox
cp $abs_top_srcdir/testsuite/mh/mbox1/4 Mail/inbox
echo "Current-Folder: inbox" > Mail/context
cat >> $MH <<EOT
mhn-store-application/octet-stream: +
EOT
mhn +inbox -store -part 2.2.1 4 | remove_curdir || exit $?
],
[0],
[storing message 4 part 2.2.1 to folder inbox as message 5
])

MH_CHECK([mhn-store-: pipe],[mhn11 mhn-store-pipe],[
mkdir Mail/inbox
cp $abs_top_srcdir/testsuite/mh/mbox1/4 Mail/inbox
echo "Current-Folder: inbox" > Mail/context
echo "mhn-store-text: | $abs_top_srcdir/mh/tests/mhed -" >> $MH
mhn +inbox -store -part 1 4 | sed 's| *$||' || exit $?
],
[0],
[-- Editor invocation: -
-- Input file:
`You are old, Father William,' the young man said,
`And your hair has become very white;
And yet you incessantly stand on your head--
Do you think, at your age, it is right?'

`In my youth,' Father William replied to his son,
`I feared it might injure the brain;
But, now that I'm perfectly sure I have none,
Why, I do it again and again.'

-- Input file end
storing msg 4 part 1 using command /home/gray/gnu/mailutils/mh/tests/mhed -
])

m4_popdef[MH_KEYWORDS])
# End of mhn.at
